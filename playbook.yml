---

- name: Update System
  hosts: none
  become: true
  gather_facts: false
  tags: "update"

  tasks: 
  - name:  Update All Packages
    ansible.builtin.package:
      name: '*'
      state: latest
    tags: "yum update"

- name: Create and Configure Gateway User
  hosts: alma
  become: true
  gather_facts: false
  tasks:
  - name: Create gateway user
    ansible.builtin.user:
      name: gateway
      shell: /bin/bash
      # groups: wheel
      append: true
    tags: "gateway user"

  - name: Create .ssh folder
    ansible.builtin.file:
      path: /home/gateway/.ssh
      state: directory
      owner: gateway
      group: gateway
      mode: 0700
    tags: "user access"

  - name: Copy SSH Key to New User
    ansible.builtin.copy:
      src: ~/.ssh/id_rsa.pub
      dest: /home/gateway/.ssh/authorized_keys
      owner: gateway
      group: gateway
      mode: 0700
    tags: "ssh user auth"


- name: Fake Echo Role
  hosts: none
  become: true
  gather_facts: false
  tasks:
  - name: Fake role
    ansible.builtin.include_role:
      name: test
    tags: "test role"

- name: Create and Run Gateway Container
  hosts: alma
  become: true
  gather_facts: false
  tasks:
  - name: Install Podman
    ansible.builtin.package:
      name: 'podman'
      state: latest

  - name: Pull Flex-Gateway Image
    become_user: gateway
    containers.podman.podman_image:
      name: mulesoft/flex-gateway:1.1.0
    tags: "pulling image"

  - name: Create and Enable Container
    become_user: gateway
    containers.podman.podman_container:
      name: flexgateway
      image: flex-gateway:1.1.0
      state: started
      detach: true
      exposed_ports:
        - 80
      ports:
        - 4000:4000
        - 9999:9999
        - 15001:15001
        - 15002:15002
    tags: "running container"
